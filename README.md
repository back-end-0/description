# دليل رفع الصور وتطبيق التصوير

## نظرة عامة

هذا الدليل مخصص لشرح طرق رفع الصور المختلفة في النظام.

يوجد **4 طرق** لرفع الصور:

```
┌──────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    طرق رفع الصور                                                 │
├──────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                           من تطبيق التصوير (Mobile App)                                 │   │
│   ├─────────────────────────────────┬───────────────────────────────────────────────────────┤   │
│   │  1. add_generic_photo           │  2. add_photo                                         │   │
│   │  (بدون SKU)                     │  (مع SKU)                                             │   │
│   │                                 │                                                        │   │
│   │  رفع صور + بيانات أساسية        │  إضافة صور لمنتج موجود                                │   │
│   │  ينشئ Excel تلقائي              │  يربط الصور بالمنتج عبر SKU                           │   │
│   └─────────────────────────────────┴───────────────────────────────────────────────────────┘   │
│                                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                           من لوحة التحكم (Admin Panel)                                  │   │
│   ├─────────────────────────────────┬───────────────────────────────────────────────────────┤   │
│   │  3. Upload Image without SKU    │  4. Upload Image with SKU                             │   │
│   │  (رفع ZIP بدون SKU)             │  (رفع ZIP مع SKU)                                     │   │
│   │                                 │                                                        │   │
│   │  رفع مجلدات صور بالجملة         │  ربط صور بمنتجات موجودة                               │   │
│   │  كل مجلد = منتج                 │  اسم المجلد/الصورة = SKU                              │   │
│   └─────────────────────────────────┴───────────────────────────────────────────────────────┘   │
│                                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

# 1. تطبيق التصوير - بدون SKU (add_generic_photo)

## ما هو؟
API يُستخدم من تطبيق الموبايل لفريق التصوير لرفع صور منتجات **جديدة** (ليس لها SKU بعد).

**API Endpoint:** `POST /api/v2/seller/products/add_generic_photo`

**الملف:** `ProductSkuController.php:836`

---

## السيناريو الكامل

```
📱 تطبيق التصوير                     🖥️ النظام (API)
    │                                   │
    │  📤 إرسال طلب مع:                 │
    │  • seller_id                      │
    │  • timestamp (فريد لكل منتج)      │
    │  • brand_name                     │
    │  • category_id                    │
    │  • file[] (الصور - 3 على الأقل)   │
    │  • quantity (اختياري)             │
    │  • price (اختياري)                │
    │  • warranty (اختياري)             │
    │ ──────────────────────────────────>
    │                                   │
    │                            🔒 فحص Rate Limit:
    │                            (10 طلبات/دقيقة لكل seller)
    │                                   │
    │                            ✅ التحقق من البائع:
    │                            • هل موجود؟
    │                            • هل نشط (غير محظور)؟
    │                                   │
    │                            🖼️ لكل صورة:
    │                            • فحص الصيغة (webp فقط)
    │                            • فحص الحجم (< 10MB)
    │                            • فحص الأبعاد (100-5000px)
    │                            • رفع إلى S3 بترقيم (1.webp, 2.webp...)
    │                            • تتبع Progress في Cache
    │                                   │
    │                            📁 المسار في S3:
    │                            uploads/generic_photos/{env}/{seller_id}/{timestamp}/
    │                                   │
    │                            📄 إنشاء/تحديث ملف Excel:
    │                            excel/{env}/generic_photos/{seller_id}/{date}.xlsx
    │                            (يُضاف صف جديد لهذا المنتج)
    │                                   │
    │                            🏪 تحديث Shop:
    │                            has_excel_files = true
    │                                   │
    │  ✅ Response:                     │
    │  {                                │
    │    "success": true,               │
    │    "message": "uploaded"          │
    │  }                                │
    │ <──────────────────────────────────
```

---

## ماذا يحدث لملف Excel؟

```
📄 ملف Excel: excel/{env}/generic_photos/{seller_id}/{date}.xlsx

┌─────────┬─────────┬──────────┬─────────┬──────────┬─────────────┬────────────┬───────┬─────────┐
│ name_en │ name_ar │ category │ brand   │ ...      │ seller_id   │folder_name │ qty   │ price   │
│         │         │          │         │          │             │            │       │         │
├─────────┼─────────┼──────────┼─────────┼──────────┼─────────────┼────────────┼───────┼─────────┤
│ (فارغ)  │ (فارغ)  │ الكترو.. │ Samsung │ ...      │ 560         │ 170412345  │ 100   │ 500     │
├─────────┼─────────┼──────────┼─────────┼──────────┼─────────────┼────────────┼───────┼─────────┤
│ (فارغ)  │ (فارغ)  │ الكترو.. │ Apple   │ ...      │ 560         │ 170412567  │ 50    │ 1200    │
└─────────┴─────────┴──────────┴─────────┴──────────┴─────────────┴────────────┴───────┴─────────┘
    ⬆️                                                                 ⬆️
    يُملأ لاحقاً                                              يُضاف تلقائياً من التطبيق
```

**كل مرة يُرفع منتج جديد:**
- إذا الملف موجود لهذا اليوم ← يُضاف صف جديد
- إذا الملف غير موجود ← يُنشأ ملف جديد

---

## هيكل مجلدات الصور على S3

```
uploads/generic_photos/
    └── production/                     ← البيئة
        └── 560/                        ← seller_id
            ├── 1704123456789/          ← timestamp (منتج 1)
            │   ├── 1.webp              ← الصورة الأولى (thumbnail)
            │   ├── 2.webp
            │   └── 3.webp
            │
            └── 1704123567890/          ← timestamp آخر (منتج 2)
                ├── 1.webp
                ├── 2.webp
                ├── 3.webp
                └── 4.webp
```

---

## متطلبات الصور

| المتطلب | القيمة |
|---------|--------|
| **الحد الأدنى للصور** | 3 صور |
| **الصيغة المدعومة** | WEBP فقط |
| **الحجم الأقصى** | 10 ميجابايت لكل صورة |
| **الأبعاد الدنيا** | 100 × 100 بكسل |
| **الأبعاد القصوى** | 5000 × 5000 بكسل |

## الحدود (Rate Limits)

| الحد | القيمة |
|------|--------|
| **طلبات في الدقيقة** | 10 لكل seller |
| **أقصى عدد ملفات يومياً** | 1000 صورة |
| **أقصى حجم يومي** | 500 ميجابايت |
| **أقصى عدد دفعات يومياً** | 50 دفعة |

---

# 2. تطبيق التصوير - مع SKU (add_photo)

## ما هو؟
API يُستخدم من تطبيق الموبايل لإضافة صور لمنتج **موجود مسبقاً** في النظام باستخدام رقم SKU.

**API Endpoint:** `POST /api/v2/seller/products/add_photo`

**الملف:** `ProductSkuController.php:735`

---

## السيناريو الكامل

```
📱 تطبيق التصوير                     🖥️ النظام (API)
    │                                   │
    │  1️⃣ أولاً: فحص SKU               │
    │  GET /check-photo?qr_code=SKU123  │
    │ ──────────────────────────────────>
    │                                   │
    │                            🔍 البحث عن المنتج بـ SKU
    │                                   │
    │  📊 Response:                     │
    │  {                                │
    │    "exists": true/false,          │
    │    "image": "url..." (إن وجدت)    │
    │  }                                │
    │ <──────────────────────────────────
    │                                   │
    │  2️⃣ ثانياً: رفع الصور            │
    │  POST /add_photo                  │
    │  • sku                            │
    │  • thumbnail_img (index)          │
    │  • file[] (الصور)                 │
    │  • seller_id (اختياري)            │
    │ ──────────────────────────────────>
    │                                   │
    │                    ┌──────────────┴──────────────┐
    │                    ▼                             ▼
    │         SKU موجود + له صور              SKU موجود بدون صور
    │                    │                     أو SKU جديد
    │                    │                             │
    │         ❌ "Photos already                       │
    │            exist for SKU"                        │
    │                    │                             │
    │                    │                    📁 رفع الصور إلى S3:
    │                    │                    uploads/all/{env}/sku/{sku}/
    │                    │                             │
    │                    │                    📦 تحديث/إنشاء SystemProduct:
    │                    │                    • photos = "id1, id2, id3"
    │                    │                    • thumbnail_img = selected
    │                    │                             │
    │  ✅ "Photos added successfully"                  │
    │ <────────────────────────────────────────────────┘
```

---

## شروط مهمة

| الشرط | التفصيل |
|-------|---------|
| **لا يمكن إضافة صور لمنتج له صور** | إذا المنتج له صور مسبقاً، يرفض الطلب |
| **يُنشئ منتج جديد إذا SKU غير موجود** | يتم إنشاء SystemProduct جديد |
| **أي صيغة صور مقبولة** | jpg, jpeg, png, gif, webp |

---

## المسار على S3

```
uploads/all/{env}/sku/
    └── ABC12345/                       ← SKU
        ├── 1.webp
        ├── 2.webp
        └── 3.webp
```

---

# 3. لوحة التحكم - رفع ZIP بدون SKU

## ما هو؟
رفع ملف ZIP يحتوي على مجلدات متعددة من الصور، كل مجلد يمثل منتج **جديد**.
الصور تُرفع فقط ولا تُربط بمنتجات موجودة.

**المكان في الأدمن:** Upload Image File **without** SKU

**Route:** `POST /api/v2/seller/products/add_generic_photo` (مع `zip_file`)

**Job:** `ProcessGenericPhotosJob` (Queue: `admin_file_uploads`)

**الملف:** `ProductSkuController.php:851-916`

---

## هيكل ملف ZIP المطلوب

```
{seller_id}.zip                         ← اسم الملف = seller_id
    └── {seller_id}/                    ← مجلد بنفس الـ seller_id (اختياري)
        ├── product_folder_1/           ← مجلد المنتج الأول (= folder_name في Excel)
        │   ├── 1.webp
        │   ├── 2.webp
        │   └── 3.webp
        │
        ├── product_folder_2/           ← مجلد المنتج الثاني
        │   ├── photo1.webp
        │   ├── photo2.webp
        │   └── photo3.webp
        │
        └── product_folder_3/           ← مجلد المنتج الثالث
            ├── a.webp
            ├── b.webp
            └── c.webp
```

**ملاحظة مهمة:**
- اسم ملف ZIP يجب أن يكون الـ seller_id (مثل: `560.zip`)
- أو أول مجلد داخل الـ ZIP يجب أن يكون رقمي (seller_id)
- الصيغ المدعومة: `webp, jpg, png, gif`

---

## السيناريو الكامل

```
👨‍💼 الأدمن                            🖥️ النظام
    │                                   │
    │  📦 رفع ملف ZIP من لوحة التحكم    │
    │  (زر "Upload Image without SKU")  │
    │ ──────────────────────────────────>
    │                                   │
    │                            🔍 استخراج seller_id من:
    │                            1. اسم ملف ZIP
    │                            2. أو أول مجلد داخل ZIP
    │                                   │
    │                            📂 لكل مجلد داخل ZIP:
    │                            • فتح وقراءة الملفات
    │                            • فلترة الصور فقط
    │                            • تجاهل __MACOSX والملفات المخفية
    │                            • رفع مباشرة إلى S3 (بدون temp files)
    │                            • ترقيم الصور (1.ext, 2.ext, 3.ext...)
    │                                   │
    │                            📁 المسار في S3:
    │                            uploads/generic_photos/{env}/{seller_id}/{folder_name}/
    │                                   │
    │  📊 عرض النتيجة:                  │
    │  • عدد المجلدات المعالجة          │
    │  • إجمالي الصور المرفوعة          │
    │  • الأخطاء (إن وجدت)              │
    │ <──────────────────────────────────
```

---

## ماذا يحدث في الخلفية؟

```
ProcessGenericPhotosJob (Queue: admin_file_uploads)
                │
                ▼
        ┌───────────────────┐
        │ 1. فتح ملف ZIP   │
        └─────────┬─────────┘
                  │
                  ▼
        ┌───────────────────┐
        │ 2. استخراج       │
        │    seller_id      │
        └─────────┬─────────┘
                  │
                  ▼
        ┌───────────────────┐
        │ 3. لكل مجلد:      │
        │    • قراءة الصور  │
        │    • رفعها لـ S3  │
        │    • ترقيمها      │
        └─────────┬─────────┘
                  │
                  ▼
        ┌───────────────────┐
        │ 4. تسجيل النتائج  │
        │    في Cache      │
        └─────────┬─────────┘
                  │
                  ▼
        ┌───────────────────┐
        │ 5. حذف ملف ZIP   │
        │    المؤقت        │
        └───────────────────┘
```

**الـ Cache Keys:**
- `generic_upload_status:user_{userId}` → حالة التقدم
- `generic_upload_result:user_{userId}` → النتيجة النهائية

---

# 4. لوحة التحكم - رفع ZIP مع SKU

## ما هو؟
رفع ملف ZIP يحتوي على صور لمنتجات **موجودة مسبقاً** في النظام.
يتم ربط الصور بالمنتجات عن طريق **اسم المجلد = SKU**.

**المكان في الأدمن:** Upload Image File **with** SKU

**Route:** `POST /admin/products/images/upload`

**Job:** `ProcessZipUploadJob`

**الملف:** `ProductBulkUploadController.php:253`

---

## هيكل ملف ZIP المطلوب

```
images.zip
    ├── ABC12345/                       ← اسم المجلد = SKU
    │   ├── 1.webp                      ← الصورة الرئيسية
    │   ├── ABC12345_2.webp             ← صورة إضافية
    │   └── ABC12345_3.webp             ← صورة إضافية
    │
    ├── XYZ67890/                       ← SKU آخر
    │   ├── 1.webp
    │   └── XYZ67890_2.webp
    │
    └── DEF11111/                       ← SKU ثالث
        ├── main.webp
        ├── DEF11111_2.webp
        └── DEF11111_3.webp
```

**تسمية الصور:**
- `{SKU}.webp` أو `1.webp` ← الصورة الرئيسية (main)
- `{SKU}_2.webp`, `{SKU}_3.webp` ← صور إضافية (extra)

---

## السيناريو الكامل

```
👨‍💼 الأدمن                            🖥️ النظام
    │                                   │
    │  📦 رفع ملف ZIP من لوحة التحكم    │
    │  (زر "Upload Image with SKU")     │
    │ ──────────────────────────────────>
    │                                   │
    │                            📂 فتح واستخراج ZIP
    │                                   │
    │                            🖼️ لكل صورة webp:
    │                            • استخراج SKU من اسم المجلد
    │                            • فحص الأبعاد (max 1000x1000)
    │                            • فحص الحجم (max 1MB)
    │                                   │
    │                            🔍 لكل SKU:
    │                            • البحث في SystemProduct
    │                            • إذا موجود ← ربط الصور
    │                            • إذا غير موجود ← تسجيل خطأ
    │                                   │
    │                            📁 رفع الصور إلى S3:
    │                            uploads/all/{env}/sku/{sku}/
    │                                   │
    │                            📦 تحديث SystemProduct:
    │                            • photos = "id1, id2, id3"
    │                            • thumbnail_img = main image
    │                                   │
    │  📊 عرض النتيجة:                  │
    │  • عدد الصور المرفوعة             │
    │  • SKUs غير موجودة (أخطاء)        │
    │ <──────────────────────────────────
```

---

## ماذا يحدث في الخلفية؟

```
ProcessZipUploadJob
        │
        ▼
┌───────────────────────┐
│ 1. فتح واستخراج ZIP   │
└───────────┬───────────┘
            │
            ▼
┌───────────────────────┐
│ 2. فلترة صور webp    │
│    (max 1MB, 1000px)  │
└───────────┬───────────┘
            │
            ▼
┌───────────────────────┐
│ 3. تجميع الصور بـ SKU │
│    parseImageInfo()   │
└───────────┬───────────┘
            │
            ▼
┌───────────────────────┐
│ 4. لكل SKU:           │
│    • جلب المنتج       │
│    • رفع الصور لـ S3  │
│    • تحديث المنتج     │
└───────────┬───────────┘
            │
            ▼
┌───────────────────────┐
│ 5. حذف الملفات المؤقتة│
│    CleanupZipFilesJob │
└───────────────────────┘
```

**الـ Cache Keys:**
- `zip_upload_status:user_{userId}` → حالة التقدم
- `zip_upload_result:user_{userId}` → النتيجة النهائية

---

## متطلبات الصور (مع SKU)

| المتطلب | القيمة |
|---------|--------|
| **الصيغة** | WEBP فقط |
| **الحجم الأقصى** | 1 ميجابايت لكل صورة |
| **الأبعاد القصوى** | 1000 × 1000 بكسل |
| **عدد الصور لكل منتج** | غير محدود |

---

# مقارنة بين الطرق الأربع

| | 1. تطبيق (بدون SKU) | 2. تطبيق (مع SKU) | 3. أدمن ZIP (بدون SKU) | 4. أدمن ZIP (مع SKU) |
|---|---------------------|-------------------|------------------------|----------------------|
| **من يستخدم** | فريق التصوير | فريق التصوير | الأدمن | الأدمن |
| **Endpoint** | `add_generic_photo` | `add_photo` | `add_generic_photo` (zip) | `uploadZip` |
| **يحتاج SKU؟** | ❌ لا | ✅ نعم | ❌ لا | ✅ نعم |
| **يربط بمنتج؟** | ❌ لا | ✅ نعم | ❌ لا | ✅ نعم |
| **يُنشئ Excel؟** | ✅ نعم | ❌ لا | ❌ لا | ❌ لا |
| **عدد المنتجات** | منتج واحد | منتج واحد | عدة منتجات | عدة منتجات |
| **الصيغ المدعومة** | webp فقط | الكل | webp,jpg,png,gif | webp فقط |
| **مسار S3** | `generic_photos/{seller}/{ts}` | `sku/{sku}/` | `generic_photos/{seller}/{folder}` | `sku/{sku}/` |
| **Job** | - | - | `ProcessGenericPhotosJob` | `ProcessZipUploadJob` |

---

# المشاكل الشائعة وحلولها

## أخطاء تطبيق التصوير - بدون SKU (add_generic_photo)

| المشكلة | السبب | الحل |
|---------|-------|------|
| "Too many upload attempts" | تجاوز 10 طلبات/دقيقة | انتظر ثم حاول مجدداً |
| "Seller not found" | seller_id غير موجود | تأكد من صحة seller_id |
| "Seller account is not active" | البائع محظور | تواصل مع الدعم |
| "Minimum 3 photos required" | أقل من 3 صور | ارفع 3 صور على الأقل |
| "Invalid extension detected" | صيغة غير webp | استخدم صور webp فقط |

## أخطاء تطبيق التصوير - مع SKU (add_photo)

| المشكلة | السبب | الحل |
|---------|-------|------|
| "Photos already exist for this SKU" | المنتج له صور مسبقاً | لا يمكن إضافة صور لمنتج له صور |

## أخطاء رفع ZIP بدون SKU (أدمن)

| المشكلة | السبب | الحل |
|---------|-------|------|
| "Failed to open ZIP file" | ملف ZIP تالف | أعد ضغط الملفات |
| "Unable to extract seller_id from ZIP" | اسم الملف خاطئ | سمِّ الملف برقم seller_id (مثل: 560.zip) |
| "Seller ID does not exist" | seller_id غير موجود | تأكد من صحة الرقم |

## أخطاء رفع ZIP مع SKU (أدمن)

| المشكلة | السبب | الحل |
|---------|-------|------|
| "Product not found for SKU" | SKU غير موجود في النظام | تأكد من أن المنتج موجود أولاً |
| "Image too large" | الصورة أكبر من 1000x1000 | قلل حجم الصورة |
| "ZIP file is empty" | ملف ZIP فارغ | تأكد من وجود صور داخل ZIP |

---

# ملخص التدفق الكامل

```
                    ┌─────────────────────────────────┐
                    │           رفع الصور            │
                    └───────────────┬─────────────────┘
                                    │
        ┌───────────────────────────┴───────────────────────────┐
        │                                                       │
        ▼                                                       ▼
┌───────────────────────┐                           ┌───────────────────────┐
│   من التطبيق 📱       │                           │   من لوحة التحكم 🖥️   │
└───────────┬───────────┘                           └───────────┬───────────┘
            │                                                   │
    ┌───────┴───────┐                                   ┌───────┴───────┐
    ▼               ▼                                   ▼               ▼
┌────────┐    ┌────────┐                          ┌────────┐    ┌────────┐
│ بدون   │    │  مع    │                          │ بدون   │    │  مع    │
│  SKU   │    │  SKU   │                          │  SKU   │    │  SKU   │
│        │    │        │                          │  ZIP   │    │  ZIP   │
└────┬───┘    └────┬───┘                          └────┬───┘    └────┬───┘
     │             │                                   │             │
     ▼             ▼                                   ▼             ▼
┌─────────┐  ┌─────────┐                         ┌─────────┐  ┌─────────┐
│S3:      │  │S3:      │                         │S3:      │  │S3:      │
│generic_ │  │sku/     │                         │generic_ │  │sku/     │
│photos/  │  │{sku}/   │                         │photos/  │  │{sku}/   │
│{seller}/│  │         │                         │{seller}/│  │         │
│{ts}/    │  │         │                         │{folder}/│  │         │
└────┬────┘  └────┬────┘                         └─────────┘  └────┬────┘
     │            │                                                │
     ▼            │                                                │
┌─────────┐       │                                                │
│ Excel   │       │                                                │
│ تلقائي  │       │                                                │
└────┬────┘       │                                                │
     │            │                                                │
     └────────────┼────────────────────────────────────────────────┘
                  │
                  ▼
        ┌─────────────────────┐
        │  SystemProduct      │
        │  (منتجات النظام)    │
        │                     │
        │  photos = "1,2,3"   │
        │  thumbnail_img = 1  │
        └─────────────────────┘
```

---

# نصائح للمصورين

## ✅ أفضل الممارسات:

1. **استخدم صيغة WEBP** لجميع الصور (إلزامي للتطبيق)

2. **تأكد من وجود 3 صور على الأقل** لكل منتج في add_generic_photo

3. **استخدم timestamp فريد** لكل منتج في التطبيق

4. **سمِّ ملفات ZIP بشكل صحيح:**
   - بدون SKU: اسم الملف = seller_id (مثل: `560.zip`)
   - مع SKU: أي اسم، لكن المجلدات داخله = SKU

5. **لا تحاول إضافة صور لمنتج له صور** في add_photo

## ⚠️ تجنب:

- ❌ رفع أكثر من 10 طلبات في الدقيقة من التطبيق
- ❌ استخدام صيغ غير webp في تطبيق التصوير
- ❌ صور أكبر من 1000x1000 في رفع ZIP مع SKU
- ❌ إضافة صور لمنتج له صور مسبقاً
